<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/style.css">
    
    <script src="https://cdn.jsdelivr.net"></script>
</head>
<body>
<div class="slot-machine">
    <div class="lcd-container">
    <div id="lcd-screen">
        <div class="default-screen">
            <p class="logo-text">testSlot</p>
            <p class="sub-text">Press Space to Start</p>
        </div>
    </div>
</div>

    <div class="panel-container">
        <div class="counter-box" style="width: 60px;">
        <span class="label">WAIT</span>
        <div id="wait-lamp" class="lamp-off">â—</div>
    </div>

        <div class="counter-box">
            <span class="label">CREDIT</span>
            <span id="credit-num" class="seg-display">50</span>
        </div>
        <div class="counter-box">
            <span class="label">PAYOUT</span>
            <span id="payout-num" class="seg-display">0</span>
        </div>
        <div class="state-box" style="text-align:center; margin-top:5px;">
            <span id="state-display" style="color: #fff; font-weight: bold; font-size: 20px;">NORMAL</span>
            <br>
            <span id="sub-info" style="color: #aaa; font-size: 14px;">--</span>
        </div>
    </div>
    <div class="navi-container" style="text-align:center; height: 30px; margin-bottom: 5px;">
        <span id="navi-0" class="navi-number" style="display:none;">1</span>
        <span id="navi-1" class="navi-number" style="display:none;">2</span>
        <span id="navi-2" class="navi-number" style="display:none;">3</span>
    </div>
    <div class="reel-container">
        <div id="warning-overlay" style="display: none;">
            âš  å·¦æŠ¼ã—æ¨å¥¨ âš 
        </div>
        <div class="reel" id="reel1">
            <img src="./img/blue_7.png" class="symbol">
            <img src="./img/red_7.png" class="symbol">
            <img src="./img/cherry.png" class="symbol">
        </div>
        <div class="reel" id="reel2">
            <img src="./img/cherry.png" class="symbol">
            <img src="./img/red_7.png" class="symbol">
            <img src="./img/bell.png" class="symbol">
        </div>
        <div class="reel" id="reel3">
            <img src="./img/bell.png" class="symbol">
            <img src="./img/red_7.png" class="symbol">
            <img src="./img/replay.png" class="symbol">
        </div>
    </div>

    <div class="button-container">
        <div class="stop-btn btn-red" id="btn-0" onclick="stopReel(0, tgtIndex)">1</div>
        <div class="stop-btn btn-red" id="btn-1" onclick="stopReel(1, tgtIndex)">2</div>
        <div class="stop-btn btn-red" id="btn-2" onclick="stopReel(2, tgtIndex)">3</div>
    </div>
    
    </div>

    <!--<p>Q:ãƒ¬ãƒãƒ¼ã‚ªãƒ³ã€€â†ï¼šå·¦ãƒªãƒ¼ãƒ«ã€€â†“ï¼šä¸­ãƒªãƒ¼ãƒ«ã€€â†’ï¼šå³ãƒªãƒ¼ãƒ«</p>-->



    <script>
    // å·¦ãƒ»ä¸­ãƒ»å³ãƒªãƒ¼ãƒ«ã®å›³æŸ„é…åˆ—ï¼ˆè³‡æ–™ã®ãƒªãƒ¼ãƒ«é…ç½®ã‚’åæ˜ ï¼‰
    const leftReelSymbols = [//å·¦
        './img/replay.png','./img/watermelon.png','./img/bell.png','./img/blue_7.png',
        './img/strawberry.png','./img/replay.png','./img/bell.png','./img/watermelon.png',
        './img/cherry.png','./img/red_7.png','./img/replay.png','./img/watermelon.png',
        './img/bell.png','./img/blue_7.png','./img/strawberry.png','./img/replay.png',
        './img/bell.png','./img/watermelon.png','./img/cherry.png','./img/red_7.png',
        './img/blue_7.png'
    ];

    const centerReelSymbols = [//ä¸­
        './img/watermelon.png','./img/replay.png','./img/bell.png','./img/watermelon.png',
        './img/strawberry.png','./img/cherry.png','./img/watermelon.png',
        './img/replay.png','./img/bell.png','./img/blue_7.png','./img/strawberry.png',
        './img/red_7.png','./img/bell.png','./img/cherry.png','./img/strawberry.png',
        './img/watermelon.png','./img/replay.png','./img/bell.png','./img/red_7.png',
        './img/cherry.png','./img/strawberry.png',
    ];

    const rightReelSymbols = [//å³
        './img/replay.png','./img/cherry.png','./img/bell.png','./img/watermelon.png',
        './img/bell.png','./img/replay.png','./img/cherry.png','./img/blue_7.png',
        './img/bell.png','./img/watermelon.png','./img/bell.png','./img/replay.png',
        './img/strawberry.png','./img/bell.png','./img/watermelon.png','./img/bell.png',
        './img/replay.png','./img/red_7.png','./img/bell.png','./img/watermelon.png',
        './img/bell.png'
    ];

// â–  ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å®šç¾©ï¼ˆè¿½åŠ ç‰ˆï¼‰
const GAME_STATE = {
    NORMAL: "NORMAL",
    CZ: "CZ",
    BONUS_REG_WAIT: "REG_WAIT",
    LAST_CHALLENGE: "LAST_CHALLENGE",
    BONUS_BIG: "BIG",          // åˆå›BIGï¼ˆATç¢ºå®šï¼‰
    AT: "AT_RUSH",             // é€šå¸¸ATï¼ˆRUSHï¼‰
    AT_HYPER: "AT_HYPER",      // ä¸Šä½ATï¼ˆHYPER RUSHï¼‰
    JUDGE_PREP: "JUDGE_PREP",  // ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸æº–å‚™ä¸­ï¼ˆ1æšå½¹å¾…ã¡ï¼‰
    JUDGE_ACT: "JUDGE_ACT",     // ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸ä¸­ï¼ˆ5Gï¼‰
    PULL_BACK: "PULL_BACK"      //å¼•ãæˆ»ã—åŒºé–“
};

let isAT = false;  //ä¸Šä½ATä¸­ã‹ã©ã†ã‹

let pullBackGames = 0;   // å¼•ãæˆ»ã—æ®‹ã‚ŠGæ•°
let isUpperAT = false;   // ä¸Šä½ATãƒ•ãƒ©ã‚°
const PULLBACK_WIN_RATE = 100 / 32.0; // 3.125% (1/32.0)


//ã‚µã‚¦ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«é›†åˆæ‰€
const cz_enter = new Audio('./sounds/cz_enter.mp3');
const strstrawberry = new Audio('./sounds/veryHot.mp3');
const freeze = new Audio('./sounds/freeeeez.mp3');
const freezeBig = new Audio('./sounds/freezBig.mp3');
const dropcoin = new Audio('./sounds/payout.mp3');
const bell_order = new Audio('./sounds/orderbell.mp3');
//ã“ã“ã¾ã§

// â–  è¿½åŠ å¤‰æ•°
let atGames = 0;       // ATã®æ®‹ã‚Šã‚²ãƒ¼ãƒ æ•°
let judgePrepCount = 0; // æº–å‚™ä¸­ã®1æšå½¹æˆç«‹å›æ•°
let judgeGames = 0;     // ã‚¸ãƒ£ãƒƒã‚¸ã®æ¶ˆåŒ–ã‚²ãƒ¼ãƒ æ•°
let hasAtStock = false; // ç¶™ç¶šã‚¹ãƒˆãƒƒã‚¯ã®æœ‰ç„¡

let spiningLReel = false;
let spiningCReel = false;
let spiningRReel = false;

// â–  ãƒ‡ãƒãƒƒã‚°ç”¨å¤‰æ•°ï¼ˆnullãªã‚‰é€šå¸¸æŠ½é¸ã€ä½•ã‹å…¥ã£ã¦ã„ã‚Œã°å¼·åˆ¶å½“é¸ï¼‰
let debugForcedRole = null;

const reelLength = 21;
const rotationTime = 750; // 1å›è»¢0.75ç§’
const frameInterval = rotationTime / reelLength; // â‰ˆ 35.7msã§1ã‚³ãƒé€²ã‚€
//rotationTime / reelLength

let currentIndex = [17,16,15];
let reelTimers = [];

let lastGameStartTime = 0; // å‰å›ã®ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚åˆ»
const MIN_WAIT_TIME = 4100; // ã‚¦ã‚§ã‚¤ãƒˆæ™‚é–“ (ãƒŸãƒªç§’) = 4.1ç§’
let isWaiting = false; // ã‚¦ã‚§ã‚¤ãƒˆä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

// â–  ç¾åœ¨ã®è¨­å®š (1, 2, 3, 4, 5, 6, "L")
let currentSetting = Math.floor(Math.random() * 6) + 1;; 

// â–  è¨­å®šåˆ¥ãƒ»å½“é¸ç¢ºç‡ãƒ†ãƒ¼ãƒ–ãƒ« (2026/01/16ä»•æ§˜æ›¸æº–æ‹ )
// â€»ç¢ºç‡ã¯ã€Œå½“é¸ç¢ºç‡(%)ã€
const SETTING_TABLE = {
    1: {
        CZ: { "å¼±ãƒã‚§": 10, "ã‚¹ã‚¤ã‚«å¼±": 5, "ã‚¹ã‚¤ã‚«å¼·": 20, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 40, "å¼·ã‚¤ãƒã‚´": 60, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.1 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.01, "ãƒ™ãƒ«": 0.01, "å¼±ãƒã‚§": 0.2, "ãƒãƒ£ãƒ³ã‚¹": 1.0, "å¼·ãƒã‚§": 5.0, "å¼·ã‚¤ãƒã‚´": 10.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.02 }
    },
    2: {
        CZ: { "å¼±ãƒã‚§": 12, "ã‚¹ã‚¤ã‚«å¼±": 6, "ã‚¹ã‚¤ã‚«å¼·": 22, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 45, "å¼·ã‚¤ãƒã‚´": 65, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.2 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.02, "ãƒ™ãƒ«": 0.02, "å¼±ãƒã‚§": 0.4, "ãƒãƒ£ãƒ³ã‚¹": 1.5, "å¼·ãƒã‚§": 6.0, "å¼·ã‚¤ãƒã‚´": 12.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.04 }
    },
    3: {
        CZ: { "å¼±ãƒã‚§": 14, "ã‚¹ã‚¤ã‚«å¼±": 7, "ã‚¹ã‚¤ã‚«å¼·": 24, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 50, "å¼·ã‚¤ãƒã‚´": 70, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.3 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.03, "ãƒ™ãƒ«": 0.03, "å¼±ãƒã‚§": 0.6, "ãƒãƒ£ãƒ³ã‚¹": 2.0, "å¼·ãƒã‚§": 7.0, "å¼·ã‚¤ãƒã‚´": 14.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.06 }
    },
    4: {
        CZ: { "å¼±ãƒã‚§": 16, "ã‚¹ã‚¤ã‚«å¼±": 8, "ã‚¹ã‚¤ã‚«å¼·": 26, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 55, "å¼·ã‚¤ãƒã‚´": 75, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.4 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.05, "ãƒ™ãƒ«": 0.05, "å¼±ãƒã‚§": 1.0, "ãƒãƒ£ãƒ³ã‚¹": 3.0, "å¼·ãƒã‚§": 10.0, "å¼·ã‚¤ãƒã‚´": 18.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.1 }
    },
    5: {
        CZ: { "å¼±ãƒã‚§": 18, "ã‚¹ã‚¤ã‚«å¼±": 10, "ã‚¹ã‚¤ã‚«å¼·": 30, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 60, "å¼·ã‚¤ãƒã‚´": 80, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.5 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.08, "ãƒ™ãƒ«": 0.08, "å¼±ãƒã‚§": 2.0, "ãƒãƒ£ãƒ³ã‚¹": 5.0, "å¼·ãƒã‚§": 12.0, "å¼·ã‚¤ãƒã‚´": 22.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.2 }
    },
    6: {
        CZ: { "å¼±ãƒã‚§": 25, "ã‚¹ã‚¤ã‚«å¼±": 15, "ã‚¹ã‚¤ã‚«å¼·": 40, "ãƒãƒ£ãƒ³ã‚¹": 75, "å¼·ãƒã‚§": 70, "å¼·ã‚¤ãƒã‚´": 90, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 1.0 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0.1, "ãƒ™ãƒ«": 0.1, "å¼±ãƒã‚§": 3.0, "ãƒãƒ£ãƒ³ã‚¹": 8.0, "å¼·ãƒã‚§": 15.0, "å¼·ã‚¤ãƒã‚´": 30.0, "ä¸­ãƒã‚§": 100, "ä¸€æšå½¹": 0.5 }
    },
    "L": {
        CZ: { "å¼±ãƒã‚§": 0.1, "ã‚¹ã‚¤ã‚«å¼±": 0.1, "ã‚¹ã‚¤ã‚«å¼·": 1.0, "ãƒãƒ£ãƒ³ã‚¹": 1.0, "å¼·ãƒã‚§": 5.0, "å¼·ã‚¤ãƒã‚´": 10.0, "ä¸­ãƒã‚§": 50, "ä¸€æšå½¹": 0 },
        DIRECT_BIG: { "ãƒªãƒ—ãƒ¬ã‚¤": 0, "ãƒ™ãƒ«": 0, "å¼±ãƒã‚§": 0, "ãƒãƒ£ãƒ³ã‚¹": 0, "å¼·ãƒã‚§": 0, "å¼·ã‚¤ãƒã‚´": 0, "ä¸­ãƒã‚§": 0, "ä¸€æšå½¹": 0 }
    }
};



function waitSeconds(seconds) {
    return new Promise(resolve => setTimeout(resolve, seconds * 1000));
}

const stopPatterns = {//æŒ‡å®šå€¤+2ãŒä¸­å¤®ã«æ¥ã‚‹å›³æŸ„
    "ä¸€æšå½¹": { left: "ANY", center: "ANY", right: "ANY" },
    "ãƒªãƒ—ãƒ¬ã‚¤": { left: [4,9,14,20], center: [6,15,21], right: [4,10,15,20] },
    "ãƒ™ãƒ«" : {left: [5,11,15,1], center: [7,11,16,1], right: [3,7,9,12,14,17,19,1]},
    "å¼±ãƒã‚§": {left: [6,8,16,18], center: "ANY", right: "ANY"},
    "ãƒãƒ£ãƒ³ã‚¹": {left: [1,5,11,15], center: [2,5,14,20], right: [6,16]},
    "ã‚¹ã‚¤ã‚«å¼±": {left:[5,9,15,20], center:[2,5,14,20], right:[3,9,14,19]},
    "ã‚¹ã‚¤ã‚«å¼·": {left:[6,10,16,21], center:[2,5,14,20], right:[2,6,8,13,16,18]},
    "å¼·ãƒã‚§": {left:[6,16], center:[3,11,17], right:[4,20]},
    "å¼·ã‚¤ãƒã‚´": {left:[3,13], center:[3,9,13,19], right:[11]},
    "æŠ¼ã—é †ãƒ™ãƒ«": { left: [5,11,15,1], center: [7,11,16,1], right: [3,7,9,12,14,17,19,1] },
    "ä¸­ãƒã‚§": {left:[7,17], center:"ANY", right:"ANY"},
    "Gæ•°å¢—åŠ -å¼±": {left:[2,12,19], center:[8], right:[6]},//é’7æƒã„
    "Gæ•°å¢—åŠ -å¼·": {left:[8,18], center:[10,17], right:[16]}//èµ¤7æƒã„
};

const orderPatterns = [
    [1, 0, 2], [1, 2, 0], // ä¸­ç¬¬ä¸€
    [2, 0, 1], [2, 1, 0]  // å³ç¬¬ä¸€
];

const reels = [
    leftReelSymbols,
    centerReelSymbols,
    rightReelSymbols
];

// â–  å½“é¸ã—ãŸå½¹ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å¤‰æ•°
let currentHitRole = null;

// â–  æ‰•ã„å‡ºã—æšæ•°ã®è¨­å®š (PDFå‚ç…§)
// ã‚­ãƒ¼åã¯ stopPatterns ã‚„ lottery é…åˆ—ã®æ–‡å­—åˆ—ã¨ä¸€è‡´ã•ã›ã‚‹
const payoutMap = {
    "ä¸€æšå½¹": 1,         // 
    "ãƒ™ãƒ«": 8,           // 
    "æŠ¼ã—é †ãƒ™ãƒ«": 15,     // 
    "ä¸­ãƒã‚§": 15,        // 
    "ä¸­æ®µãƒã‚§ãƒªãƒ¼": 15,
    
    // ä»¥ä¸‹ã¯å…¨ã¦ãƒªãƒ—ãƒ¬ã‚¤æ‰±ã„ï¼ˆå†éŠæŠ€ï¼‰
    "ãƒªãƒ—ãƒ¬ã‚¤": "REPLAY", // 
    "å¼±ãƒã‚§": "REPLAY",   // 
    "å¼·ãƒã‚§": "REPLAY",
    "ã‚¹ã‚¤ã‚«å¼±": "REPLAY", // 
    "ã‚¹ã‚¤ã‚«å¼·": "REPLAY",
    "ãƒãƒ£ãƒ³ã‚¹": "REPLAY",
    "å¼·ã‚¤ãƒã‚´": "REPLAY",
    "Gæ•°å¢—åŠ ": "REPLAY"
};

// â–  è¨­å®š1æƒ³å®šã®å½“é¸æœŸå¾…åº¦ï¼ˆ%ï¼‰
// â€»æœ¬æ¥ã¯ã‚‚ã£ã¨ç´°ã‹ã„ãŒã€ä½“æ„Ÿã§æ°—æŒã¡ã„ã„ãƒãƒ©ãƒ³ã‚¹ã«ã—ã¦ã‚ã‚‹
/*const LOTTERY_RATES = {
    // CZå½“é¸ç‡ (%)
    CZ: {
        "å¼±ãƒã‚§": 5,
        "ã‚¹ã‚¤ã‚«å¼±": 10,
        "ã‚¹ã‚¤ã‚«å¼·": 20,
        "ãƒãƒ£ãƒ³ã‚¹": 25,
        "å¼·ãƒã‚§": 40,
        "å¼·ã‚¤ãƒã‚´": 80, // æ¿€ç†±
        "ä¸­ãƒã‚§": 100,     // ä¸­ãƒã‚§ã¯ç›´æ’ƒç¢ºå®šã®ä»–ã«ã€CZçªç ´ç¢ºå®šã«ã‚‚ã—ãŸã„
        "ä¸€æšå½¹":1
    },
    // BIGç›´æ’ƒ(ãƒ•ãƒªãƒ¼ã‚º)å½“é¸ç‡ (%)
    DIRECT_BIG: {
        "ãƒªãƒ—ãƒ¬ã‚¤": 0.5, // ãƒªãƒ—é€£ãªã©ã®æ¦‚å¿µãŒãªã„å ´åˆã€è–„ãæŠ½é¸
        "ãƒ™ãƒ«": 0.1,
        "å¼±ãƒã‚§": 1,
        "ãƒãƒ£ãƒ³ã‚¹": 5,
        "å¼·ãƒã‚§": 10,
        "å¼·ã‚¤ãƒã‚´": 25,
        "ä¸­ãƒã‚§": 100,    // ç¢ºå®šï¼
        "ä¸€æšå½¹":0.1
    }
};*/

// â–  è¨­å®šï¼šCZä¸­ã®ãƒœãƒ¼ãƒŠã‚¹å½“é¸ç¢ºç‡ (%)
// â€»PDFã®ã‚¹ãƒšãƒƒã‚¯ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã‚Œ
const CZ_CONFIG = {
    GAMES: 10, // CZã®ç¶™ç¶šã‚²ãƒ¼ãƒ æ•°
    
    // å°å½¹ã”ã¨ã®è§£é™¤æœŸå¾…åº¦
    HIT_RATES: {
        "ãƒªãƒ—ãƒ¬ã‚¤": 5,    // ãƒªãƒ—ã§ã‚‚5%
        "ãƒ™ãƒ«": 10,       // ãƒ™ãƒ«é€£ãŒç†±ã„ã‹ã‚‚
        "æŠ¼ã—é †ãƒ™ãƒ«": 10,
        "å¼±ãƒã‚§": 30,
        "ã‚¹ã‚¤ã‚«å¼±": 30,
        "ã‚¹ã‚¤ã‚«å¼·": 60,   // æ¿€ç†±
        "ãƒãƒ£ãƒ³ã‚¹": 50,
        "å¼·ãƒã‚§": 100,    // ç¢ºå®šç´š
        "å¼·ã‚¤ãƒã‚´": 100,
        "ä¸­ãƒã‚§": 100,
        "ä¸€æšå½¹": 1       // åŸºæœ¬ã¯ãƒãƒ¼ãƒãƒ£ãƒ³ã‚¹ã¨ã¯ã„ãˆã€ãã‚Œã¯ãã‚Œã§ã‹ã‚ã„ãã†
    }
};

let reelStartTime = 0; // ãƒªãƒ¼ãƒ«ãŒå›ã‚Šå§‹ã‚ãŸæ™‚åˆ»ã‚’ä¿å­˜
const STOP_LOCK_TIME = 850; // ç„¡åŠ¹æ™‚é–“ï¼ˆ0.5ç§’ = 500msï¼‰

let czRemainingGames = 0; // CZã®æ®‹ã‚ŠGæ•°

let rondom;

let isBusy = false; // æ‰•ã„å‡ºã—ã‚„æ¼”å‡ºä¸­ã¯ true ã«ãªã‚‹

let Normal_lottery = [];
let AT_lottery = [];

// â–  å¤‰å‰‡æ‰“ã¡ãƒšãƒŠãƒ«ãƒ†ã‚£ç”¨ã®ãƒ•ãƒ©ã‚°
let isPenalty = false;

setInterval(() => {
    rondom = Math.floor( Math.random() * 65536 );
}, 10);

let tgtIndex = [0,0,0];

// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚¨ãƒªã‚¢ ---
let isStopping = false; // ã€Œä»Šåœæ­¢å‡¦ç†ä¸­ã‹ï¼Ÿã€ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°

// å¤‰æ•°å®šç¾©ã®ã‚ãŸã‚Šã«è¿½åŠ 
let credits = 777;  // åˆæœŸæŒã¡ãƒ¡ãƒ€ãƒ«
let payout = 0;    // æ‰•ã„å‡ºã—æšæ•°

function updateButtonLights(i) {
    const currentTime = Date.now();
    
        const btn = document.getElementById(`btn-${i}`);
        // æ¡ä»¶ï¼šãƒªãƒ¼ãƒ«ãŒå›è»¢ä¸­ã€ã‹ã¤ã€é–‹å§‹ã‹ã‚‰0.5ç§’ï¼ˆSTOP_LOCK_TIMEï¼‰ä»¥ä¸ŠçµŒé
        const canStop = spiningLReel && spiningCReel && spiningRReel && (currentTime - reelStartTime >= STOP_LOCK_TIME);

        if (canStop) {
            btn.classList.remove('btn-red');
            btn.classList.add('btn-blue');
        } else {
            btn.classList.remove('btn-blue');
            btn.classList.add('btn-red');
        }
    
}

function updateStateDisplay() {
    const stateEl = document.getElementById('state-display');
    const subEl = document.getElementById('sub-info');
    
    stateEl.textContent = currentState;

    if (currentState === GAME_STATE.AT) {
        stateEl.style.color = "gold"; 
        // â˜…ã“ã“ã§ atGames ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹ï¼Ÿ
        subEl.textContent = `æ®‹ã‚Š ${atGames} G`; 
    }

    else if (currentState === GAME_STATE.CZ) {
        stateEl.style.color = "#00ff00"; // ãƒ©ã‚¤ãƒ ã‚°ãƒªãƒ¼ãƒ³
        subEl.textContent = `æ®‹ã‚Š ${czRemainingGames} G`;
    }
    
    // --- æ—¢å­˜ã®è¡¨ç¤ºå‡¦ç† ---
    else if (currentState === GAME_STATE.BONUS_REG_WAIT) {
        stateEl.style.color = "yellow";
        subEl.textContent = `ãƒ™ãƒ«å›æ•°: ${regBellCount}/7`;
    } else if (currentState === GAME_STATE.LAST_CHALLENGE) {
        stateEl.style.color = "red";
        subEl.textContent = `LAST CHALLENGE: ${lastChallengeG}/5G`;
    } 
    // --- â˜…è¿½åŠ ï¼šATä¸­ã®è¡¨ç¤º ---
    else if (currentState === GAME_STATE.AT || currentState === GAME_STATE.AT_HYPER) {
        if (currentState === GAME_STATE.AT_HYPER) {
            stateEl.style.color = "#FFD700"; // ã‚´ãƒ¼ãƒ«ãƒ‰
            // CSSã§å…‰å½©ã‚’æ”¾ã¤
            stateEl.style.textShadow = "0 0 10px #FFD700, 0 0 20px #FF4500"; 
            stateEl.textContent = "HYPER ALICE RUSH"; // åå‰ã¯ãŠå¥½ã¿ã§
        } else {
            stateEl.style.color = "magenta";
            stateEl.style.textShadow = "none";
            stateEl.textContent = "RUSH";
        }
        subEl.textContent = `æ®‹ã‚ŠGæ•°: ${atGames}G`;
    }
    else if (currentState === GAME_STATE.JUDGE_PREP) {
        stateEl.style.color = "cyan";
        subEl.textContent = `æº–å‚™ä¸­... 1æšå½¹: ${judgePrepCount}/2`;
    }
    else if (currentState === GAME_STATE.JUDGE_ACT) {
        stateEl.style.color = "orange";
        subEl.textContent = `ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸: ${judgeGames}/5G`;
    }
    else {
        stateEl.style.color = "white";
        subEl.textContent = "--";
    }
}

// â–  ä¸Šä½ATé–‹å§‹å‡¦ç†
function startHyperAT() {
//     alert("ä¸Šä½ATã€ŒHYPER RUSHã€çªå…¥ï¼");
    currentState = GAME_STATE.AT_HYPER;
    atGames = 50; // ä»•æ§˜ï¼š50Gã‚¹ã‚¿ãƒ¼ãƒˆ
    hyperStock = 0; // ã‚¹ãƒˆãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆ
    
    // --- 80%ãƒ«ãƒ¼ãƒ—æŠ½é¸ ---
    // ç¶™ç¶šç‡80%ã§ã€Œä½•å€‹ã‚¹ãƒˆãƒƒã‚¯ã‚’æŒã¦ã‚‹ã‹ã€ã‚’ä¸€æ°—ã«æŠ½é¸ã™ã‚‹
    // â€»åˆå›åˆ†ã¯ä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¦ã€è¿½åŠ åˆ†ã‚’æŠ½é¸ã™ã‚‹ã‹ã€
    //   ã‚ã‚‹ã„ã¯åˆå›ã‚»ãƒƒãƒˆã‚‚ã“ã®ãƒ«ãƒ¼ãƒ—ã«å«ã‚ã‚‹ã‹ã¯ä»•æ§˜æ¬¡ç¬¬ã ãŒã€
    //   ä»Šå›ã¯ã€Œçªå…¥ï¼1ã‚»ãƒƒãƒˆç›®ã€ï¼‹ã€Œè£ã§ã‚¹ãƒˆãƒƒã‚¯æŠ½é¸ã€ã¨ã™ã‚‹ãœã€‚
    
    while(Math.random() < 0.8) {
        hyperStock++;
    }
    
//     console.log(`ä¸Šä½ATçªå…¥ï¼ ç²å¾—ã‚¹ãƒˆãƒƒã‚¯æ•°: ${hyperStock}`);
//     alert(`ä¸Šä½ATã€ŒHYPER RUSHã€çªå…¥ï¼\n(æœŸå¾…åº¦ç´„80%ãƒ«ãƒ¼ãƒ—)`);
    
    updateStateDisplay();
}

// â–  é€šå¸¸ATé–‹å§‹å‡¦ç†ï¼ˆBIGå¾Œãªã©ï¼‰
async function startNormalAT(initialG) {
    currentState = GAME_STATE.AT;

    atGames = initialG; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20G

    hasAtStock = false; // é€šå¸¸ã¯ã‚¹ãƒˆãƒƒã‚¯ãªã—ã¨ã™ã‚‹ï¼ˆæŠ½é¸å…¥ã‚Œã¦ã‚‚è‰¯ã„ï¼‰
    updateStateDisplay();
}

// â–  CZçªå…¥å‡¦ç†ï¼ˆåˆæœŸåŒ–ï¼‰
async function enterCZ() {
    cz_enter.currentTime = 0;
    cz_enter.play();
    //await waitSeconds(3);
//     alert("ãƒãƒ£ãƒ³ã‚¹ã‚¾ãƒ¼ãƒ³çªå…¥ï¼ 10Gä»¥å†…ã«ãƒœãƒ¼ãƒŠã‚¹ã‚’æ´ã‚ï¼");
    currentState = GAME_STATE.CZ;
    czRemainingGames = CZ_CONFIG.GAMES;

    isBusy = false;
    
    // æ¼”å‡ºï¼šèƒŒæ™¯ã‚’å¤‰ãˆã‚‹ã¨ã‹ã€æ–‡å­—è‰²ã‚’å¤‰ãˆã‚‹ã¨ã‹
    document.querySelector('.panel-container').style.borderColor = "#00ff00"; // ç·‘æ ã«å¤‰åŒ–
    updateStateDisplay();
}

// â–  çŠ¶æ…‹ç§»è¡Œãƒã‚§ãƒƒã‚¯ï¼ˆATãƒ»ã‚¸ãƒ£ãƒƒã‚¸é–¢é€£ã‚’è¿½åŠ ï¼‰
function checkStateTransition() {
    // --- 1. é€šå¸¸æ™‚ã®æŠ½é¸ ---
    // 1. é€šå¸¸æ™‚ã®æŠ½é¸
    if (currentState === GAME_STATE.NORMAL) {
        
        // è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«ã®å–å¾—ï¼ˆãªã‘ã‚Œã°è¨­å®š1ï¼‰
        const currentRates = SETTING_TABLE[currentSetting] || SETTING_TABLE[1];

        // â–  ç›´æ’ƒBIGæŠ½é¸ï¼ˆé˜²å¼¾ä»•æ§˜ï¼‰
        // "DIRECT_BIG" ã¨ã„ã†ç®±ãŒã‚ã‚Šã€ã‹ã¤ "ä»Šã®å½¹" ã®ç¢ºç‡ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
        let bigRate = 0;
        if (currentRates.DIRECT_BIG && typeof currentRates.DIRECT_BIG[currentHitRole] !== 'undefined') {
            bigRate = currentRates.DIRECT_BIG[currentHitRole];
        }

        if (Math.random() * 100 < bigRate) {
            if (currentHitRole === "ä¸­ãƒã‚§") performFreeze();
            else startBonus(true);
            return;
        }

        // â–  CZæŠ½é¸ï¼ˆé˜²å¼¾ä»•æ§˜ï¼‰
        // "CZ" ã¨ã„ã†ç®±ãŒã‚ã‚Šã€ã‹ã¤ "ä»Šã®å½¹" ã®ç¢ºç‡ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
        let czRate = 0;
        if (currentRates.CZ && typeof currentRates.CZ[currentHitRole] !== 'undefined') {
            czRate = currentRates.CZ[currentHitRole];
        }

        if (Math.random() * 100 < czRate) {
            isBusy = true;
            enterCZ();
        }
    }

    // --- 2. REGå¾…ã¡ (å‡¦ç†ãªã—) ---
    // â€»ãƒ™ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã¯ checkPayout å´ã§ã‚„ã£ã¦ã‚‹ã‹ã‚‰ã€ã“ã“ã¯ç©ºã£ã½ã§ã„ã„ã€‚
    // ç„¡ç†ã«æ›¸ãã¨äºŒé‡åˆ¤å®šã«ãªã‚‹ã‹ã‚‰ãªã€‚

    // --- 3. â˜…ã“ã“ãŒé‡è¦ï¼šãƒ©ã‚¹ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®é€²è¡Œå‡¦ç† ---
    else if (currentState === GAME_STATE.LAST_CHALLENGE) {
        lastChallengeG++; // ã‚²ãƒ¼ãƒ æ•°ã‚’é€²ã‚ã‚‹
//         console.log(`ãƒ©ã‚¹ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸æ¶ˆåŒ–: ${lastChallengeG}/5`);

        let isSuccess = false;

        // â‘  ç¢ºç‡æŠ½é¸ (1/10 = 10%)
        if (Math.random() < 0.1) isSuccess = true;

        // â‘¡ å°å½¹æ›¸ãæ›ãˆ (å¼·ãƒ¬ã‚¢å½¹ãªã‚‰ç¢ºå®šï¼)
        // â€»PDFä»•æ§˜: ã€Œ5Gã®é–“ã«ãƒ¬ã‚¢å½¹ã‚’å¼•ã or å¤§å½“ãŸã‚Šã‚’å¼•ã„ãŸã‚‰ATã€
        if (["å¼·ãƒã‚§", "ãƒãƒ£ãƒ³ã‚¹", "ã‚¹ã‚¤ã‚«å¼·", "å¼·ã‚¤ãƒã‚´", "ä¸­ãƒã‚§"].includes(currentHitRole)) {
            isSuccess = true;
//             console.log("ãƒ¬ã‚¢å½¹ã§ã­ã˜è¾¼ã‚“ã ï¼");
        }

        if (isSuccess) {
//             alert("ãƒ©ã‚¹ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ï¼ RUSHçªå…¥ï¼");
            // ATé–‹å§‹å‡¦ç†ã¸
            startNormalAT(20); 
            return;
        }

        // å¤±æ•—åˆ¤å®š (5Gæ¶ˆåŒ–ã—ã¦ãƒ€ãƒ¡ã ã£ãŸå ´åˆ)
        if (lastChallengeG >= 5) {
//             alert("ãƒ©ã‚¹ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—â€¦â€¦ é€šå¸¸ã¸");
            currentState = GAME_STATE.NORMAL;
            // æ è‰²ã¨ã‹å¤‰ãˆã¦ãŸã‚‰æˆ»ã™å‡¦ç†ã‚‚ã“ã“ã«
        }
    }

    // --- 4. CZä¸­ ---
    else if (currentState === GAME_STATE.CZ) {
        // ... (æ—¢å­˜ã®CZå‡¦ç†) ...
        // ã•ã£ãä½œã£ãŸã‚„ã¤ãŒã‚ã‚Œã°ãã®ã¾ã¾
        czRemainingGames--;
        let rate = CZ_CONFIG.HIT_RATES[currentHitRole] || 0;
        if (Math.random() * 100 < rate) {
//             alert("CZæˆåŠŸï¼");
            document.querySelector('.panel-container').style.borderColor = "#555";
            startBonus();
            return;
        }
        if (czRemainingGames <= 0) {
//             alert("CZå¤±æ•—...");
            currentState = GAME_STATE.NORMAL;
            document.querySelector('.panel-container').style.borderColor = "#555";
        }
    }

    // --- 5. ATä¸­ (é€šå¸¸ãƒ»ä¸Šä½å…±é€š) ---
    if (currentState === GAME_STATE.AT || currentState === GAME_STATE.AT_HYPER) {
        atGames--; // ã‚²ãƒ¼ãƒ æ•°æ¶ˆåŒ–
        
        // --- æ¼”å‡ºå¼·åŒ–: ä¸Šä½ATä¸­ã¯æ–‡å­—ã‚’ãƒ”ã‚«ãƒ”ã‚«ã•ã›ãŸã„ãªã‚‰ã“ã“ ---
        // (updateStateDisplayã§ã‚„ã£ã¦ã‚‹ã‹ã‚‰ãã®ã¾ã¾ã§OK)

        if (atGames <= 0) {
            // â˜…è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯: ä¸Šä½ATã§ã‚¹ãƒˆãƒƒã‚¯ãŒã‚ã‚‹å ´åˆ
            if (currentState === GAME_STATE.AT_HYPER && hyperStock > 0) {
                hyperStock--; // ã‚¹ãƒˆãƒƒã‚¯æ¶ˆè²»
                atGames = 20; // ã‚²ãƒ¼ãƒ æ•°å†ã‚»ãƒƒãƒˆ
                
                // æ¼”å‡º: çµ‚ã‚ã£ãŸã¨è¦‹ã›ã‹ã‘ã¦â€¦ï¼Ÿ
//                 alert("HYPER RUSH ç¶™ç¶š");
//                 console.log(`HYPERç¶™ç¶šï¼ æ®‹ã‚Šã‚¹ãƒˆãƒƒã‚¯: ${hyperStock}`);
                updateStateDisplay();
                return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚ãˆã¦ã€ã‚¸ãƒ£ãƒƒã‚¸ã¸ã¯è¡Œã‹ã›ãªã„
            }

            // ã‚¹ãƒˆãƒƒã‚¯ãŒãªã„ã€ã¾ãŸã¯é€šå¸¸ATãªã‚‰çµ‚äº†ã—ã¦ã‚¸ãƒ£ãƒƒã‚¸ã¸
//             alert("ATçµ‚äº†â€¦â€¦ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸ã¸");
            isAT = false;
            currentState = GAME_STATE.JUDGE_PREP;
            judgePrepCount = 0;
            
            // ç”»é¢ã®è£…é£¾ã‚’æˆ»ã™ï¼ˆã‚‚ã—å¤‰ãˆã¦ã„ã‚Œã°ï¼‰
            document.getElementById('state-display').style.textShadow = "none";
        }
    }

    // --- 6. ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸æº–å‚™ä¸­ ---
    else if (currentState === GAME_STATE.JUDGE_PREP) {
        // PDFä»•æ§˜ï¼š1æšæ‰•ã„å‡ºã—(å¼±ã‚¤ãƒã‚´/ä¸€æšå½¹)ãŒ2å›å‡ºã‚‹ã¾ã§å¾…æ©Ÿ
        if (currentHitRole === "ä¸€æšå½¹" || currentHitRole === "å¼±ã‚¤ãƒã‚´") { // åå‰ã¯å®šç¾©ã«åˆã‚ã›ã¦
            judgePrepCount++;
        }
        
        if (judgePrepCount >= 2) {
//             alert("æº–å‚™å®Œäº†ï¼ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸é–‹å§‹(5G)ï¼");
            currentState = GAME_STATE.JUDGE_ACT;
            judgeGames = 0;
        }
    }

    // --- 7. ç¶™ç¶šã‚¸ãƒ£ãƒƒã‚¸ (5G) ---
    else if (currentState === GAME_STATE.JUDGE_ACT) {
        judgeGames++;
        
        let isSuccess = false;
        let isHyper = false;

        // ã‚¹ãƒˆãƒƒã‚¯ãŒã‚ã‚Œã°ç„¡æ¡ä»¶æˆåŠŸ
        if (hasAtStock) {
            isSuccess = true;
            // ä¸Šä½ATä¸­ãªã‚‰ç¶™ç¶šç¢ºå®šï¼ä¸Šä½ãƒ«ãƒ¼ãƒ—
            if (currentState === GAME_STATE.AT_HYPER) isHyper = true; 
            hasAtStock = false; // ã‚¹ãƒˆãƒƒã‚¯æ¶ˆè²»
//             console.log("ã‚¹ãƒˆãƒƒã‚¯æ”¾å‡ºï¼");
            isAT = true;
        } 
        // è‡ªåŠ›æŠ½é¸ (ãƒ¬ã‚¢å½¹ or 1/6)
        else {
            if (Math.random() < (1/6)) isSuccess = true;
            if (["å¼·ãƒã‚§", "ãƒãƒ£ãƒ³ã‚¹", "ã‚¹ã‚¤ã‚«å¼·"].includes(currentHitRole)) isSuccess = true;
        }

        if (isSuccess) {
            // PDFä»•æ§˜ï¼š1/25ã§ä¸Šä½ATã¸
            if (Math.random() < (1/25)) {
                isAT = true;
                isUpperAT = true;
                startHyperAT();
            } else {
                // é€šå¸¸ATã¸å¾©å¸°ï¼ˆã‚²ãƒ¼ãƒ æ•°ã¯æŒ¯ã‚Šåˆ†ã‘ã ãŒä»Šå›ã¯20Gå›ºå®šã§ï¼‰
//                 alert("ç¶™ç¶šæˆåŠŸï¼RUSHå¾©å¸°ï¼");
                isAT = true;
                // ã‚‚ã—å…ƒã€…ä¸Šä½ATã ã£ãŸå ´åˆã¯ã©ã†ã™ã‚‹ã‹ï¼Ÿ
                // ä»•æ§˜ã®èª­ã¿è§£ãã«ã‚ˆã‚‹ãŒã€ä¸€èˆ¬çš„ã«ä¸Šä½ãƒ«ãƒ¼ãƒ—æ¼ã‚Œã¯é€šå¸¸ATã«è½ã¡ã‚‹ã‹çµ‚ã‚ã‚‹ã‹ã€‚
                // ã“ã“ã§ã¯ã€ŒæˆåŠŸï¼ç¾çŠ¶ç¶­æŒä»¥ä¸Šã€ã¨ã—ã¦ãŠãã€‚
                if (currentState === GAME_STATE.AT_HYPER) startHyperAT(); // ãƒ«ãƒ¼ãƒ—
                else startNormalAT(20);
            }
            return; // å‡¦ç†çµ‚äº†
        }

        // 5Gé§†ã‘æŠœã‘å¤±æ•—
        if (judgeGames >= 5) {
//             alert("ã‚¸ãƒ£ãƒƒã‚¸å¤±æ•—â€¦â€¦é€šå¸¸ã¸");
            if (isUpperAT) {
                pullBackGames = 72; // ä¸Šä½å¾Œã¯72G
            } else {
                pullBackGames = 66; // é€šå¸¸å¾Œã¯66G
            }
//             console.log("å¼•ãæˆ»ã—åŒºé–“çªå…¥ï¼š" + pullBackGames);
            currentState = GAME_STATE.PULL_BACK;
            isAT = false;
            // å¼•ãæˆ»ã—åŒºé–“(66G)ãªã©ã¯ã“ã“ã«å®Ÿè£…ã™ã‚‹ãŒã€ã¾ãšã¯é€šå¸¸ã¸æˆ»ã™
        }
    }
    else if (currentState === GAME_STATE.PULL_BACK) {
        pullBackGames--;

        // 1/32.0 ã®å¼•ãæˆ»ã—æŠ½é¸ 
        if (Math.random() * 100 < PULLBACK_WIN_RATE) {
//             console.log("ğŸ”¥ å¼•ãæˆ»ã—æˆåŠŸï¼ ğŸ”¥");
            strstrawberry.currentTime = 0;
            strstrawberry.play();
            startBonus(true); // ATå¾©å¸°
            pullBackGames = 0;
            return;
        }

        // è¦å®šã‚²ãƒ¼ãƒ æ•°æ¶ˆåŒ–ã§é€šå¸¸ã¸
        if (pullBackGames <= 0) {
//             console.log("å¼•ãæˆ»ã—å¤±æ•—ã€‚é€šå¸¸ã¸æˆ»ã‚Šã¾ã™");
            currentState = GAME_STATE.NORMAL;
            isUpperAT = false;
        }
    }

    updateStateDisplay();
}
/*
spiningLReel = true;
        spiningCReel = true;
        spiningRReel = true;
*/

// ã‚¦ã‚§ã‚¤ãƒˆã‚’è€ƒæ…®ã—ã¦å›è»¢ã‚’è©¦ã¿ã‚‹é–¢æ•°
function attemptSpin() {
    // ã™ã§ã«å›ã£ã¦ã„ã‚‹ã€ã¾ãŸã¯ã‚¦ã‚§ã‚¤ãƒˆå‡¦ç†ä¸­ãªã‚‰ç„¡è¦–
    if (isStopping || isWaiting || spiningLReel || spiningCReel || spiningRReel) return;

    const now = Date.now();
    const timeSinceLastStart = now - lastGameStartTime; // å‰å›ã®é–‹å§‹ã‹ã‚‰ä½•ãƒŸãƒªç§’çµŒã£ãŸã‹

    if (timeSinceLastStart < MIN_WAIT_TIME) {
        // --- ã‚¦ã‚§ã‚¤ãƒˆç™ºç”Ÿï¼ ---
        const waitDuration = MIN_WAIT_TIME - timeSinceLastStart; // æ®‹ã‚Šå¾…ã¡æ™‚é–“
        
//         console.log(`ã‚¦ã‚§ã‚¤ãƒˆä½œå‹•: æ®‹ã‚Š ${waitDuration}ms å¾…ã¡ã¾ã™`);
        isWaiting = true;
        toggleWaitLamp(true); // ãƒ©ãƒ³ãƒ—ç‚¹ç¯

        // æ®‹ã‚Šæ™‚é–“ã ã‘å¾…ã£ã¦ã‹ã‚‰å›è»¢é–‹å§‹
        setTimeout(() => {
            isWaiting = false;
            toggleWaitLamp(false); // ãƒ©ãƒ³ãƒ—æ¶ˆç¯
            startGameLogic(); // å®Ÿéš›ã®å›è»¢å‡¦ç†ã¸
        }, waitDuration);

    } else {
        // --- ã‚¦ã‚§ã‚¤ãƒˆãªã—ï¼ˆ4.1ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ï¼‰ ---
        startGameLogic();
    }
}

// ãƒ©ãƒ³ãƒ—ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹é–¢æ•°
function toggleWaitLamp(isOn) {
    const lamp = document.getElementById('wait-lamp');
    if (isOn) {
        lamp.className = "lamp-on";
    } else {
        lamp.className = "lamp-off";
    }
}

// å®Ÿéš›ã®å›è»¢é–‹å§‹å‡¦ç†ï¼ˆæ—¢å­˜ã® srartReel ã®ä¸­èº«ã®æœ€åˆã§æ™‚åˆ»æ›´æ–°ã‚’ã™ã‚‹ï¼‰
function startGameLogic() {
    lastGameStartTime = Date.now(); // â˜…ã“ã“ã§ã€Œä»Šå›ã®é–‹å§‹æ™‚åˆ»ã€ã‚’è¨˜éŒ²
    startReels(); // æ—¢å­˜ã®å›è»¢é–¢æ•°ã‚’å®Ÿè¡Œ
}

// â–  ãƒ•ãƒªãƒ¼ã‚ºæ¼”å‡ºï¼ˆä¸­æ®µãƒã‚§ãƒªãƒ¼ãªã©ï¼‰
async function performFreeze() {
    freeze.currentTime = 0;
    freeze.play()
    
    // ç”»é¢ã‚’æš—ãã™ã‚‹ãªã©ã®CSSæ“ä½œã‚’ã—ã¦ã‚‚ã„ã„
    document.body.style.backgroundColor = "black";
    document.querySelector('.panel-container').style.opacity = "0.2";
    
    // 5ç§’å¾Œã«å¾©å¸°ã—ã¦BIGé–‹å§‹
    setTimeout(() => {
        document.body.style.backgroundColor = ""; // å…ƒã«æˆ»ã™
        document.querySelector('.panel-container').style.opacity = "1";
        freezeBig.currentTime = 0;
        freezeBig.play()
        waitSeconds(6);
        
//         alert("é™è‡¨ï¼ BIG BONUSç¢ºå®šï¼");
        waitSeconds(6);
        isAT = true;
        startBonus(true); // BIGç¢ºå®š
    }, 5000);
}

// â–  ãƒœãƒ¼ãƒŠã‚¹é–‹å§‹å‡¦ç†ï¼ˆå¼•æ•°ã§BIGç¢ºå®šã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«æ”¹ä¿®ï¼‰
function startBonus(isForcedBig = false) {
    // isForcedBig ãŒ true ãªã‚‰BIGç¢ºå®šã€ãã†ã§ãªã‘ã‚Œã°æŒ¯ã‚Šåˆ†ã‘
    // PDFä»•æ§˜ã§ã¯åŸºæœ¬æ¯”ç‡ã¯ BIG 40% : REG 60%
    
    let isBig = isForcedBig ? true : (Math.random() < 0.4);

    if (currentSetting === "L") {
//         console.log("è¨­å®šLã®ãŸã‚ã€BIGã‚’å¼·åˆ¶çš„ã«REGã¸å¤‰æ›´");
        isBig = false;
    }
    
    if (isBig) {
        isAT = true;
            if (!isForcedBig) alert("BIG BONUSï¼ RUSHçªå…¥ï¼");
        // BIGå‡¦ç†ï¼ˆATã¸ï¼‰
        startNormalAT(20); 
    } else {
        isAT = true;
//         alert("REG BONUS... ãƒ™ãƒ«ã‚’7å›é›†ã‚ã‚ï¼");
        currentState = GAME_STATE.BONUS_REG_WAIT;
        regBellCount = 0;
    }
    updateStateDisplay();
}

// â– è¿½åŠ ï¼šç”»é¢ã®æ•°å­—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updatePanel() {
    const creditEl = document.getElementById('credit-num');
    const payoutEl = document.getElementById('payout-num');
    
    // æ¡æ•°ã‚’æƒãˆãŸã„ãªã‚‰ .toString().padStart(2, '0') ã¨ã‹ä½¿ã†ã¨ã‚«ãƒƒã‚³ã„ã„
    creditEl.textContent = credits;
    payoutEl.textContent = payout;
}

function picupRandInt() {
    
    // â– â– â–  ãƒ‡ãƒãƒƒã‚°å¼·åˆ¶ãƒ¢ãƒ¼ãƒ‰ â– â– â– 
    if (debugForcedRole !== null) {
        currentHitRole = debugForcedRole;
//         console.log(`â˜…ç¥ã®åŠ›ç™ºå‹•ï¼å¼·åˆ¶ãƒ•ãƒ©ã‚°: ${currentHitRole}`);
        
        if(currentHitRole === "å¼·ã‚¤ãƒã‚´" || currentHitRole === "å¼·ãƒã‚§" || currentHitRole === "ã‚¹ã‚¤ã‚«å¼·"){
            strstrawberry.currentTime = 0;
            strstrawberry.play();
        }
        

        // æŠ¼ã—é †ãƒ™ãƒ«ã®å ´åˆã®å‡¦ç†
        if (currentHitRole === "æŠ¼ã—é †ãƒ™ãƒ«") {
             // orderPatterns ãŒã¡ã‚ƒã‚“ã¨ã‚ã‚‹ã‹ç¢ºèª
             if (typeof orderPatterns === 'undefined') {
//                  console.error("ã€ã‚¨ãƒ©ãƒ¼ã€‘orderPatterns ãŒå®šç¾©ã•ã‚Œã¦ãªã„ãï¼ã‚³ãƒ¼ãƒ‰ã®ä¸€ç•ªä¸Šã«æ›¸ã„ãŸã‹ç¢ºèªã—ã‚ï¼");
                 return;
             }

             const randIndex = Math.floor(Math.random() * orderPatterns.length);
             correctOrder = orderPatterns[randIndex];
             
             // ãƒŠãƒ“ã‚’å‡ºã™æ¡ä»¶
             if (["AT","AT_HYPER","BIG","REG_WAIT"].includes(currentState) || currentState.includes("BONUS")) {
                 // å®‰å…¨ç­–ï¼šcorrectOrderãŒã‚ã‚Œã°è¡¨ç¤º
                 if (correctOrder) {
                     showNavi(correctOrder);
                 }
             }
        }
        
        tgtIndex = decideStop(currentHitRole);
        debugForcedRole = null; 
        return; 
    }


    let piced = rondom;
    if(!isAT){
        currentHitRole = Normal_lottery[piced]; // â˜…ä¿å­˜
//         console.log(piced + "," + Normal_lottery[piced]);
        tgtIndex = decideStop(Normal_lottery[piced]);
    }else {
        currentHitRole = AT_lottery[piced];     // â˜…ä¿å­˜
//         console.log(piced + "," + AT_lottery[piced]);
        tgtIndex = decideStop(AT_lottery[piced]);
        if (currentHitRole === "æŠ¼ã—é †ãƒ™ãƒ«") {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸ã¶
            bell_order.currentTime = 0;
            bell_order.play();
            const randIndex = Math.floor(Math.random() * orderPatterns.length);
            correctOrder = orderPatterns[randIndex];
            
//             console.log("æ­£è§£ã®æŠ¼ã—é †:", correctOrder);

            // â˜…ATä¸­ ã¾ãŸã¯ ãƒœãƒ¼ãƒŠã‚¹ä¸­ãªã‚‰ãƒŠãƒ“ã‚’å‡ºã™ï¼ˆï¼æ­£è§£ã‚’æ•™ãˆã‚‹ï¼‰
            if (currentState === GAME_STATE.AT || 
                currentState === GAME_STATE.AT_HYPER || 
                currentState === GAME_STATE.BONUS_BIG ||
                currentState === GAME_STATE.BONUS_REG_WAIT ||
                currentState === GAME_STATE.LAST_CHALLENGE)
                 {
                
                showNavi(correctOrder);
            }
        }
    }
    const heavyRoles = ["å¼·ãƒã‚§", "å¼·ã‚¤ãƒã‚´", "ã‚¹ã‚¤ã‚«å¼·", "ãƒãƒ£ãƒ³ã‚¹", "ä¸­ãƒã‚§", "Gæ•°å¢—åŠ -å¼·"];

    if (heavyRoles.includes(currentHitRole)) {
        // ãƒªãƒ¼ãƒ«å…¨ä½“ã‚’åŒ…ã‚€ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
        const container = document.querySelector('.reel-container');
        
        // ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        container.classList.add('flash-mode');
        
//         console.log("âš¡ å¼·å½¹æ¼”å‡ºç™ºç”Ÿï¼ âš¡");

        // 0.5ç§’å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å¤–ã™ï¼ˆã“ã‚Œã‚’ã—ãªã„ã¨æ¬¡ã¯å…‰ã‚‰ãªããªã‚‹ï¼‰
        setTimeout(() => {
            container.classList.remove('flash-mode');
        }, 500);
    }
}

// â–  ãƒŠãƒ“ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function showNavi(order) {
    // â˜…è¿½åŠ ï¼šorderãŒã¡ã‚ƒã‚“ã¨ã—ãŸé…åˆ—ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹å®‰å…¨è£…ç½®
    if (!Array.isArray(order) || order.length !== 3) {
        // é…åˆ—ã˜ã‚ƒãªã„ãªã‚‰ãƒŠãƒ“ã‚’æ¶ˆã—ã¦å¸°ã‚‹
        hideNavi(); 
        return;
    }

    // order ã¯ [1, 2, 0] (ä¸­ãƒ»å³ãƒ»å·¦) ã®ã‚ˆã†ãªé…åˆ—
    // index 0 ã¯å·¦ãƒªãƒ¼ãƒ«ã€1ã¯ä¸­ãƒªãƒ¼ãƒ«ã€2ã¯å³ãƒªãƒ¼ãƒ«ã«å¯¾å¿œ
    
    // å·¦ãƒªãƒ¼ãƒ«(id=navi-0) ã«ã¯ä½•ç•ªç›®ã«æŠ¼ã™ã¹ãã‹ã‚’è¡¨ç¤º
    document.getElementById('navi-0').textContent = order.indexOf(0) + 1;
    document.getElementById('navi-0').style.display = 'inline-block';

    document.getElementById('navi-1').textContent = order.indexOf(1) + 1;
    document.getElementById('navi-1').style.display = 'inline-block';

    document.getElementById('navi-2').textContent = order.indexOf(2) + 1;
    document.getElementById('navi-2').style.display = 'inline-block';
}

const forbiddenKeys = ["ãƒªãƒ—ãƒ¬ã‚¤", "ãƒ™ãƒ«", "å¼±ãƒã‚§", "ã‚¹ã‚¤ã‚«å¼±", "ã‚¹ã‚¤ã‚«å¼·", "å¼·ãƒã‚§", "å¼·ã‚¤ãƒã‚´", "ä¸­ãƒã‚§"];
let total_payout = 0;
let total_bet = 0;
let total_playGame = 0;

async function checkPayout() {
    if (isPenalty) {
        // ãƒªãƒ¼ãƒ«ä¸Šã«è­¦å‘Šæ–‡ã‚’è¡¨ç¤º
        const overlay = document.getElementById('warning-overlay');
        overlay.style.display = 'block'; // è¡¨ç¤ºã‚ªãƒ³
        
//         console.log("å¤‰å‰‡æ‰“ã¡ã®ãŸã‚æŠ½é¸ç„¡åŠ¹");
        isBusy = false; 
        return;
        
        // ãƒ•ãƒ©ã‚°ã ã‘æˆ»ã—ã¦ã€æ‰•ã„å‡ºã—å‡¦ç†ã‚’è¡Œã‚ãšã«çµ‚äº†ï¼ˆreturnï¼‰
        isBusy = false; 
        return; 
    }
    let pay = payoutMap[currentHitRole];
    if (pay === undefined) pay = 0;

    if (currentState === GAME_STATE.AT) {
        
        let addG = 0;

        // stopPatternsã®ã‚­ãƒ¼åã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ï¼
        if (currentHitRole === "Gæ•°å¢—åŠ -å¼±") {
            addG = 10; // é’7ã¯10G
        } 
        else if (currentHitRole === "Gæ•°å¢—åŠ -å¼·") {
            addG = 20; // èµ¤7ã¯20G
        }

        // ä¸Šä¹—ã›å®Ÿè¡Œ
        if (addG > 0) {
            for(let i = 0; i < addG; i++) {
                atGames++;
                updateStateDisplay();
                await waitSeconds(0.05);
            }

            // ãƒ­ã‚°ã¨æ¼”å‡º
//             console.log(`${currentHitRole}ï¼ +${addG}G`);
//             alert(`ã€ä¸Šä¹—ã›ï¼ã€‘\n${currentHitRole} GETï¼\n+${addG}G (æ®‹ã‚Š ${atGames}G)`);

            // æ¼”å‡ºï¼šå¼·ãªã‚‰èµ¤ã€å¼±ãªã‚‰ã‚·ã‚¢ãƒ³(é’)
            let color = (currentHitRole === "Gæ•°å¢—åŠ -å¼·") ? "red" : "cyan";
            let panel = document.querySelector('.panel-container');
            if(panel) {
                panel.style.borderColor = color;
                panel.style.boxShadow = `0 0 20px ${color}`;
                setTimeout(() => {
                    panel.style.borderColor = "#555";
                    panel.style.boxShadow = "inset 0 0 10px #000";
                }, 1000);
            }
            addG = 0;
        }
    }

    // --- æŠ¼ã—é †ãƒ™ãƒ«ã®åˆ¤å®š ---
    if (currentHitRole === "æŠ¼ã—é †ãƒ™ãƒ«") {
        if (JSON.stringify(playerOrder) === JSON.stringify(correctOrder)) {
//             console.log("æŠ¼ã—é †æ­£è§£ï¼");
            pay = 15; // æ­£è§£
            // ã“ã“ã§ã€ŒGOOD!ã€ã¨ã‹å‡ºã™ã¨æ°—æŒã¡ã„ã„
        } else {
//             console.log("æŠ¼ã—é †ä¸æ­£è§£...");
            pay = 1; // å¤±æ•—
        }
    }

    // --- â˜…ã“ã“ãŒé‡è¦ï¼šREGä¸­ã®ãƒ™ãƒ«ã‚«ã‚¦ãƒ³ãƒˆå‡¦ç† ---
    // çŠ¶æ…‹ãŒã€ŒREGå¾…ã¡ã€ã§ã€ã‹ã¤ã€Œãƒ™ãƒ«ã®æ‰•ã„å‡ºã—(8æšä»¥ä¸Š)ã€ãŒã‚ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆ
    if (currentState === GAME_STATE.BONUS_REG_WAIT) {
        // ã€Œãƒ™ãƒ«ã€ã¾ãŸã¯ã€ŒæŠ¼ã—é †ãƒ™ãƒ«(æ­£è§£)ã€ãªã‚‰ pay ã¯ 8 ã«ãªã£ã¦ã„ã‚‹ã¯ãš
        if (pay >= 8) {
            regBellCount++;
//             console.log(`ãƒ™ãƒ«å…¥è³ï¼ ç¾åœ¨: ${regBellCount}/7`);
            
            // è¦å®šå›æ•°åˆ°é”ãƒã‚§ãƒƒã‚¯
            if (regBellCount >= 7) {
//                 alert("ãƒ™ãƒ«è¦å®šå›æ•°åˆ°é”ï¼ãƒ©ã‚¹ãƒˆãƒãƒ£ãƒ¬ãƒ³ã‚¸çªå…¥ï¼");
                currentState = GAME_STATE.LAST_CHALLENGE;
                lastChallengeG = 0;
            }
        }
    }

    // --- æ‰•ã„å‡ºã—å®Ÿè¡Œ ---
    total_bet += 3
    total_playGame += 1;
    if (pay === "REPLAY") {
        for(let i = 0; i < 3; i++) {
            credits += 1;
            updatePanel(); 
            await waitSeconds(0.05);
        }
        payout = 0; 
//         console.log("REPLAY");
    } else if(pay == 1 || pay === "ä¸€æšå½¹"){
        credits += 1;
        payout += 1;
    }
    else {
        /*dropcoin.currentTime = 0;
        dropcoin.play();*/
        for(let i = 0; i < pay ; i++) {
            credits += 1;
            payout += 1;
            total_payout += 1;
            updatePanel(); 
            await waitSeconds(0.05);
        }
//         console.log(pay + "æšæ‰•ã„å‡ºã—");
    }

    // ä¸Šé™å‡¦ç†
    //if (credits > 99) credits = 99;

    updatePanel(); 
    checkStateTransition(); // çŠ¶æ…‹ç§»è¡Œãƒã‚§ãƒƒã‚¯ã¸ï¼ˆã‚«ã‚¦ãƒ³ãƒˆå‡¦ç†ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
    let kikaiwari = (total_payout/total_bet)*100;
    console.log("ã‚²ãƒ¼ãƒ æ•°ï¼š" + total_playGame + "\næŠ•è³‡æšæ•°ï¼š" + total_bet + "\nåˆè¨ˆæ‰•ã„å‡ºã—æšæ•°ï¼š" + total_payout + "\næ©Ÿæ¢°å‰²(%):" + kikaiwari);

    // ã‚¦ã‚§ã‚¤ãƒˆè§£é™¤
    setTimeout(() => {
        isBusy = false;
    }, 400);
}
    
    /*let pay = payoutMap[currentHitRole];
    
    // å®šç¾©ã•ã‚Œã¦ã„ãªã„å½¹ï¼ˆãƒã‚ºãƒ¬ç­‰ï¼‰ã¯0æš
    if (pay === undefined) pay = 0;

    if (currentHitRole === "æŠ¼ã—é †ãƒ™ãƒ«") {
        // é…åˆ—ã®ä¸­èº«ã‚’æ¯”è¼ƒï¼ˆJSON.stringifyã¯ãŠæ‰‹è»½æ¯”è¼ƒãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼‰
        if (JSON.stringify(playerOrder) === JSON.stringify(correctOrder)) {
//             console.log("æŠ¼ã—é †æ­£è§£ï¼ãƒ™ãƒ«GETï¼");
            pay = 8; // æ­£è§£æ™‚ã®æšæ•°ï¼ˆPDFãªã©ã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
            
            // æ¼”å‡ºï¼šãƒŠãƒ“ã‚’æ¶ˆã™ã€ã¾ãŸã¯ã€ŒGOOD!ã€ã¨ã‹å‡ºã™
            
        } else {
//             console.log("æŠ¼ã—é †ä¸æ­£è§£â€¦â€¦ã“ã¼ã—");
            pay = 1; // ã“ã¼ã—æ™‚ã®æšæ•°ï¼ˆé€šå¸¸ã¯1æšã‹0æšï¼‰
            
            // é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š
            // ä¸æ­£è§£ã®å ´åˆã€ãƒªãƒ¼ãƒ«åˆ¶å¾¡å´ã§ã€Œãƒ™ãƒ«ãŒæƒã‚ãªã„ä½ç½®ã€ã«æ­¢ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒ
            // ç°¡æ˜“å®Ÿè£…ã¨ã—ã¦ã¯ã€Œæƒã£ã¦ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã‘ã©æ‰•ã„å‡ºã—ã¯1æšã€ã«ã™ã‚‹ã‹ã€
            // decideStopé–¢æ•°å´ã§æœ€åˆã‹ã‚‰ã€Œã“ã¼ã—ç›®ã€ã‚’ç”¨æ„ã™ã‚‹ã‹ãŒãƒªã‚¢ãƒ«ã€‚
            // ä»Šå›ã¯ã¨ã‚Šã‚ãˆãšã€Œæ‰•ã„å‡ºã—æšæ•°ã‚’æ¸›ã‚‰ã™ã€ã ã‘ã§å†ç¾ã¨ã™ã‚‹ã€‚
        }
    }

    if (pay === "REPLAY") {
        // ãƒªãƒ—ãƒ¬ã‚¤ã®å ´åˆï¼š3æšæŠ•å…¥ãŒè¿”ã£ã¦ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆÂ±0ï¼‰
        // å®Ÿéš›ã®æŒ™å‹•ã¨ã—ã¦ã¯CREDITã«3åŠ ç®—ã—ã¦ã€æ¬¡ã‚²ãƒ¼ãƒ ã®BETåˆ†ã‚’è£œå¡«ã™ã‚‹
        credits += 3;
        // ãƒªãƒ—ãƒ¬ã‚¤ãƒ©ãƒ³ãƒ—ãŒã‚ã‚Œã°ç‚¹ç¯ã•ã›ã‚‹ãŒã€ä»Šå›ã¯PAYOUTè¡¨ç¤ºã¯0ã«ã—ã¦ãŠã
        payout = 0; 
//         console.log("REPLAY! å†éŠæŠ€");
    } else {
        // é€šå¸¸ã®æ‰•ã„å‡ºã—
        //credits += pay;
        //payout = pay;

        for(let i = 0; i < pay ; i++) {
            credits += 1;
            payout += 1;
            updatePanel();
            await waitSeconds(0.05);
        }
//         console.log(pay + "æšæ‰•ã„å‡ºã—");
    }

    // çŠ¶æ…‹ç§»è¡Œãƒã‚§ãƒƒã‚¯
    checkStateTransition();

    // ä¸Šé™å‡¦ç†ï¼ˆã‚¹ãƒ­ãƒƒãƒˆã¯é€šå¸¸50æšãŒä¸Šé™ã ãŒã€å®¶ã‚¹ãƒ­ãªã‚‰9999ã¨ã‹ã§ã‚‚ã„ã„ï¼‰
    //if (credits > 99) credits = 99; // ä¸€å¿œã‚«ãƒ³ã‚¹ãƒˆè¨­å®š

    updatePanel(); // ç”»é¢ã®æ•°å­—ã‚’æ›´æ–°

    isBusy = false;

    //setTimeout(() => {
    //    isBusy = false; // â˜…ãƒ­ãƒƒã‚¯è§£é™¤ï¼æ¬¡ã®ãƒ¬ãƒãƒ¼ã‚ªãƒ³OK
//     //    console.log("Next game ready.");
    //}, 400); // 400msãã‚‰ã„å¾…ãŸã›ã‚‹ã¨ã€Œå®Ÿæ©Ÿã£ã½ã„é‡ã¿ã€ãŒå‡ºã‚‹
    // 
}*/

function decideStop(result) {
    const pattern = stopPatterns[result];

    // å…¨ãƒªãƒ¼ãƒ«ï¼ˆ0:å·¦, 1:ä¸­, 2:å³ï¼‰ã«å¯¾ã—ã¦ãƒ«ãƒ¼ãƒ—å‡¦ç†
    let stops = [0, 0, 0];
    for (let r = 0; r < 3; r++) {
        let targetPositions;
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒ "ANY" ã®å ´åˆã€ç¦æ­¢ä½ç½®ã‚’é™¤å¤–ã—ã¦æŠ½é¸ã™ã‚‹
        if ((r === 0 && pattern.left === "ANY") || 
            (r === 1 && pattern.center === "ANY") || 
            (r === 2 && pattern.right === "ANY")) {
            
            // 1. ã“ã®ãƒªãƒ¼ãƒ«(r)ã«ãŠã‘ã‚‹ã€Œç¦æ­¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚’å…¨ã¦é›†ã‚ã‚‹
            let forbiddenIndices = new Set();
            forbiddenKeys.forEach(key => {
                let p = stopPatterns[key];
                let indices = (r === 0) ? p.left : (r === 1) ? p.center : p.right;
                
                if (Array.isArray(indices)) {
                    indices.forEach(idx => forbiddenIndices.add(idx));
                }
            });

            // 2. 0ï½20ã®ä¸­ã§ã€ç¦æ­¢ã•ã‚Œã¦ã„ãªã„ã€Œå®‰å…¨ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚’æŠ½å‡º
            let safeIndices = [];
            for (let i = 0; i < reelLength; i++) {
                if (!forbiddenIndices.has(i)) {
                    safeIndices.push(i);
                }
            }

            // å®‰å…¨ãªå ´æ‰€ãŒä¸€ã¤ã‚‚ãªã„å ´åˆã¯ã€ä»•æ–¹ãªã„ã®ã§currentIndexï¼ˆç¾åœ¨ã®ä½ç½®ï¼‰ã«ã™ã‚‹ãªã©ã®ä¿é™º
            if (safeIndices.length === 0) {
//                 console.warn(`ãƒªãƒ¼ãƒ«${r+1}: åœæ­¢å¯èƒ½ãªä½ç½®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`);
                stops[r] = currentIndex[r]; 
            } else {
                // 3. å®‰å…¨ãªãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
                stops[r] = safeIndices[Math.floor(Math.random() * safeIndices.length)];
            }

        } else {
            // "ANY" ã˜ã‚ƒãªã„å ´åˆã¯ã€æŒ‡å®šã•ã‚ŒãŸé…åˆ—ã‹ã‚‰é¸ã¶ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            let arr = (r === 0) ? pattern.left : (r === 1) ? pattern.center : pattern.right;
            stops[r] = Array.isArray(arr) ? arr[Math.floor(Math.random() * arr.length)] : currentIndex[r];
        }
    }

    return stops;
}

function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); // 0ã€œi ã®ã©ã‚Œã‹
                [array[i], array[j]] = [array[j], array[i]];   // è¦ç´ ã‚’äº¤æ›
            }
            return array;
        }

let correctOrder = []; // ä»Šå›ã®æ­£è§£ã®æŠ¼ã—é † (ä¾‹: [0, 1, 2])
let playerOrder = [];  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Ÿéš›ã«æŠ¼ã—ãŸé †

const CHARACTER_LINES = [
    { text: "æº–å‚™ã¯ã„ã„ï¼Ÿè¡Œãã‚ˆï¼", color: "white" },
    { text: "ãŠã£ã€ã“ã‚Œã¯ãƒãƒ£ãƒ³ã‚¹ã‹ã‚‚ï¼Ÿ", color: "blue" }, // é’æ–‡å­—ï¼ˆä¿¡é ¼åº¦UPï¼‰
    { text: "æ¿€ã‚¢ãƒ„ã ã­ï¼", color: "red" },            // èµ¤æ–‡å­—ï¼ˆé«˜æœŸå¾…åº¦ï¼‰
];

function updateLCD(state) {
    const screen = document.getElementById('lcd-screen');
    
    if (state === "start") {
        // å›è»¢é–‹å§‹æ™‚ï¼šãƒ©ãƒ³ãƒ€ãƒ ã«ã‚»ãƒªãƒ•ã‚’è¡¨ç¤º
        const rand = Math.floor(Math.random() * 10); // 0~9
        
        // 30%ã®ç¢ºç‡ã§ã‚»ãƒªãƒ•ã‚’å–‹ã‚‰ã›ã‚‹ãƒ†ã‚¹ãƒˆ
        if (rand < 3) {
            const line = CHARACTER_LINES[rand];
            screen.innerHTML = `
                <div class="message-box" style="color: ${line.color}; border-color: ${line.color};">
                    ${line.text}
                </div>
            `;
        } else {
            // ä½•ã‚‚ãªã‘ã‚Œã°æ¼”å‡ºãªã—ï¼ˆèƒŒæ™¯ã®ã¿ï¼‰
            screen.innerHTML = ""; 
        }
    } else if (state === "stop") {
        // å…¨ãƒªãƒ¼ãƒ«åœæ­¢æ™‚ï¼šå…ƒã®ç”»é¢ã«æˆ»ã™ï¼ˆã¾ãŸã¯çµæœè¡¨ç¤ºï¼‰
        screen.innerHTML = `
            <div class="default-screen">
            </div>
        `;
    }
}

function startReels() {

    if (isBusy) return;

    reelStartTime = Date.now();

    
    setTimeout(() => {
        for(let i = 0; i < 3; i++) {
            updateButtonLights(i);
        }
        
    }, STOP_LOCK_TIME);

    if (!spiningLReel && !spiningCReel && !spiningRReel) {
        // â˜…ã“ã“ã«è¿½åŠ ï¼šãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('warning-overlay').style.display = 'none';
        isPenalty = false;
        // ãƒ¡ãƒ€ãƒ«ã‚’æ¶ˆè²»
        credits -= 3;
        payout = 0; // æ‰•ã„å‡ºã—è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        updatePanel(); // ç”»é¢æ›´æ–°

        updateLCD("start");

        playerOrder = [];
        correctOrder = [];
        hideNavi(); // ãƒŠãƒ“ã‚’éš ã™é–¢æ•°ï¼ˆå¾Œã§ä½œã‚‹ï¼‰

        picupRandInt();
        spiningLReel = true;
        spiningCReel = true;
        spiningRReel = true;
        for (let r = 0; r < 3; r++) {
            // â˜…è¿½åŠ ï¼šå›è»¢ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
            document.getElementById(`reel${r+1}`).classList.add('spinning');
            reelTimers[r] = setInterval(() => {
                const reel = document.getElementById(`reel${r+1}`);
                reel.innerHTML = '';
                for (let i = 3; i > 0; i--) {
                const symbolIndex = (currentIndex[r] + i) % reelLength;
                const img = document.createElement('img');
                img.src = reels[r][symbolIndex];
                img.className = 'symbol';
                reel.appendChild(img);
                }
                currentIndex[r] = (currentIndex[r] + 1) % reelLength;
            }, frameInterval);
        }
    }
}

function hideNavi() {
    for(let i=0; i<3; i++) {
        document.getElementById(`navi-${i}`).style.display = 'none';
    }
}

function renderReel(reelIndex) {
    const reel = document.getElementById(`reel${reelIndex+1}`);
    reel.innerHTML = '';
    for (let i = 0; i < 3; i++) {
        const symbolIndex = (currentIndex[reelIndex] + i) % reelLength;
        const img = document.createElement('img');
        img.src = reels[reelIndex][symbolIndex];
        img.className = 'symbol';
        reel.appendChild(img);
    }
}


function stopReel(reelIndex, tgtIndex) {
    // 1. ä»–ã®ãƒªãƒ¼ãƒ«ã‚’åœæ­¢å‡¦ç†ä¸­ãªã‚‰ã€ã“ã®å‘¼ã³å‡ºã—ã¯å®Œå…¨ã«ç„¡è¦–ã™ã‚‹
    if (isStopping) return;

    const currentTime = Date.now();
    
    // å›ã‚Šå§‹ã‚ã¦ã‹ã‚‰ 500ms çµŒã£ã¦ã„ãªã„å ´åˆã¯ã€ä½•ã‚‚ã—ãªã„ï¼ˆreturnï¼‰
    if (currentTime - reelStartTime < STOP_LOCK_TIME || !spiningCReel && !spiningLReel && !spiningRReel) {
//         console.log("ã¾ã ãƒªãƒ¼ãƒ«ãŒå®‰å®šã—ã¦ã„ã¾ã›ã‚“ï¼");
        return;
    }

    // 2. æŒ‡å®šã•ã‚ŒãŸãƒªãƒ¼ãƒ«ãŒã€Œæ—¢ã«æ­¢ã¾ã£ã¦ã„ã‚‹ã€ãªã‚‰ã€ä½•ã‚‚ã›ãšã«é–¢æ•°ã‚’çµ‚ã‚ã‚‹
    if (reelIndex === 0 && !spiningLReel) return;
    if (reelIndex === 1 && !spiningCReel) return;
    if (reelIndex === 2 && !spiningRReel) return;

    // 3. åœæ­¢å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹ã®ã§ãƒ­ãƒƒã‚¯ã‚’ã‹ã‘ã‚‹
    isStopping = true;

    // é€šå¸¸æ™‚ç¬¬ä¸€åœæ­¢ãŒå·¦ä»¥å¤–ãªã‚‰ãƒšãƒŠãƒ«ãƒ†ã‚£ç¢ºå®š
    if (!isAT && playerOrder.length === 0 && reelIndex !== 0) {
        isPenalty = true;
//         console.log("ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼å·¦ä»¥å¤–ã‹ã‚‰æŠ¼ã•ã‚Œã¾ã—ãŸ");
    }

    // --- åœæ­¢ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    if(reelIndex == 0 && spiningLReel) {
        playerOrder.push(reelIndex);
        document.getElementById(`reel${reelIndex+1}`).classList.remove('spinning');
        clearInterval(reelTimers[reelIndex]);
        currentIndex[reelIndex] = tgtIndex[reelIndex];
        renderReel(reelIndex);
        spiningLReel = false;
        updateButtonLights(0);
    }
    else if(reelIndex == 1 && spiningCReel) { // else if ã«ã™ã‚‹ã“ã¨ã§ç¢ºå®Ÿã«1ã¤ãšã¤åˆ¤å®š
        document.getElementById(`reel${reelIndex+1}`).classList.remove('spinning');
        playerOrder.push(reelIndex);
        clearInterval(reelTimers[reelIndex]);
        currentIndex[reelIndex] = tgtIndex[reelIndex];
        renderReel(reelIndex);
        spiningCReel = false;
        updateButtonLights(1);
    }
    else if(reelIndex == 2 && spiningRReel) {
        document.getElementById(`reel${reelIndex+1}`).classList.remove('spinning');
        playerOrder.push(reelIndex);
        clearInterval(reelTimers[reelIndex]);
        currentIndex[reelIndex] = tgtIndex[reelIndex];
        renderReel(reelIndex);
        spiningRReel = false;
        updateButtonLights(2);
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®æŒ‡ãŒé›¢ã‚ŒãŸç¬é–“ã«å®Ÿè¡Œã•ã‚Œã‚‹
    window.addEventListener('keyup', (event) => {
    const key = event.key;
    // åœæ­¢ã«ä½¿ã†ã‚­ãƒ¼ï¼ˆå·¦ãƒ»ä¸‹ãƒ»å³çŸ¢å°ãªã©ï¼‰ãŒé›¢ã•ã‚ŒãŸã‚‰ãƒ­ãƒƒã‚¯è§£é™¤
    if (key === 'ArrowLeft' || key === 'ArrowDown' || key === 'ArrowRight') {
        isStopping = false; 
//         //console.log("ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚ŒãŸã®ã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
    }
});

    // â–  å…¨ã¦ã®ãƒªãƒ¼ãƒ«ãŒæ­¢ã¾ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
    if (!spiningLReel && !spiningCReel && !spiningRReel) {
        isBusy = true;
        updateLCD("stop");
        setTimeout(checkPayout, 200); 
    }
}

function loadWindow() {
//ã“ã“ã§ã‚„ã£ã¦ã„ã‚‹äº‹ã¯ã€é€šå¸¸æ™‚(CZ)æ™‚ã®æŠ½é¸ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã€ATæ™‚ã®æŠ½é¸ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç”Ÿæˆã€‚
//åˆè¨ˆãŒ65536ã«ã—ãŸã„ãŒ
    currentState = GAME_STATE.NORMAL
    let excfor = [[48338,8296,6241,964,668,452,240,171,126,40],//65536
                ["ä¸€æšå½¹","ãƒªãƒ—ãƒ¬ã‚¤","ãƒ™ãƒ«","å¼±ãƒã‚§","ãƒãƒ£ãƒ³ã‚¹","ã‚¹ã‚¤ã‚«å¼±","ã‚¹ã‚¤ã‚«å¼·","å¼·ãƒã‚§","å¼·ã‚¤ãƒã‚´","ä¸­ãƒã‚§"]];

                for(let i = 0; i < excfor[0].length; i++) {
                    for(let j = 0; j < excfor[0][i]; j++) {
                        Normal_lottery.push(excfor[1][i]);
                    }
                }
                Normal_lottery = shuffle(Normal_lottery);
//                 console.log(Normal_lottery);//278
    let excfor2 = [[25633,28400,8296,273,273,964,668,452,240,171,126,40],//Sum65536
                   ["ä¸€æšå½¹","æŠ¼ã—é †ãƒ™ãƒ«","ãƒªãƒ—ãƒ¬ã‚¤","Gæ•°å¢—åŠ -å¼±","Gæ•°å¢—åŠ -å¼·","å¼±ãƒã‚§","ãƒãƒ£ãƒ³ã‚¹","ã‚¹ã‚¤ã‚«å¼±","ã‚¹ã‚¤ã‚«å¼·","å¼·ãƒã‚§","å¼·ã‚¤ãƒã‚´","ä¸­ãƒã‚§"]];

                    for(let i = 0; i < excfor2[0].length ; i++) {
                        for(let j = 0 ;j < excfor2[0][i]; j++) {
                            AT_lottery.push(excfor2[1][i]);
                        }
                    }
                    AT_lottery = shuffle(AT_lottery);
//                     console.log(AT_lottery);
//                     console.log("ç¾åœ¨ã®è¨­å®šï¼š" + currentSetting);
}

window.onload = function() {
    loadWindow();
    updatePanel();
}

// â–  ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('keydown', function(event) {
    
    // é€£æ‰“é˜²æ­¢ã‚„ã€å¤‰ãªæŒ™å‹•ã‚’é˜²ããŸã‚ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
    // â€»ã‚‚ã—tgtIndexãŒæœªå®šç¾©ï¼ˆã¾ã å›ã—ã¦ãªã„ï¼‰ã®æ™‚ã«æ­¢ã‚ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã‚’é˜²ã
    
    switch(event.key) {
        // --- ãƒ¬ãƒãƒ¼ã‚ªãƒ³ (Qã‚­ãƒ¼) ---
        case 'q':
        case 'Q':
            // æ—¢ã«å›ã£ã¦ã„ã‚‹æ™‚ã¯åå¿œã•ã›ãªã„ç­‰ã®åˆ¶å¾¡ã¯ startReels å†…ã«ã‚ã‚‹ã¯ãšã ãŒå¿µã®ãŸã‚
            attemptSpin();
            //startReels();
            break;

        // --- å·¦åœæ­¢ (â†ã‚­ãƒ¼) ---
        case 'ArrowLeft':
            // tgtIndexãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆå›ã£ã¦ã„ã‚‹ã‹ï¼‰ãƒã‚§ãƒƒã‚¯
            if (typeof tgtIndex !== 'undefined') {
                stopReel(0, tgtIndex);
            }
            break;

        // --- ä¸­åœæ­¢ (â†“ã‚­ãƒ¼) ---
        case 'ArrowDown':
            // ãƒ‘ãƒã‚¹ãƒ­ã®çœŸã‚“ä¸­ãƒœã‚¿ãƒ³ã¯é…ç½®çš„ã«ã€Œâ†“ã€ãŒã—ã£ãã‚Šæ¥ã‚‹ã‚ˆãª
            if (typeof tgtIndex !== 'undefined') {
                stopReel(1, tgtIndex);
            }
            // ç”»é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            event.preventDefault(); 
            break;

        // --- å³åœæ­¢ (â†’ã‚­ãƒ¼) ---
        case 'ArrowRight':
            if (typeof tgtIndex !== 'undefined') {
                stopReel(2, tgtIndex);
            }
            break;


            // --- ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰ (æ•°å­—ã‚­ãƒ¼) ---
        /*case '1':
            debugForcedRole = "ãƒªãƒ—ãƒ¬ã‚¤";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : ãƒªãƒ—ãƒ¬ã‚¤");
            break;
        case '2':
            debugForcedRole = "ãƒ™ãƒ«"; // ã¾ãŸã¯ "æŠ¼ã—é †ãƒ™ãƒ«"
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : ãƒ™ãƒ«");
            break;
        case '3':
            debugForcedRole = "å¼±ãƒã‚§";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : å¼±ãƒã‚§ãƒªãƒ¼");
            break;
        case '4':
            debugForcedRole = "å¼·ãƒã‚§";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : å¼·ãƒã‚§ãƒªãƒ¼");
            break;
        case '5':
            debugForcedRole = "ãƒãƒ£ãƒ³ã‚¹";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : ãƒãƒ£ãƒ³ã‚¹ç›®");
            break;
        case '6':
            debugForcedRole = "ã‚¹ã‚¤ã‚«å¼·";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : ã‚¹ã‚¤ã‚«(å¼·)");
            break;
        case '7':
            debugForcedRole = "å¼·ã‚¤ãƒã‚´";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : å¼·ã‚¤ãƒã‚´ (æ¿€ç†±)");
            break;
        case '8':
            debugForcedRole = "Gæ•°å¢—åŠ -å¼±";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : Gæ•°å¢—åŠ -å¼±");
            break;
        case '9':
            debugForcedRole = "ä¸­ãƒã‚§";
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : ä¸­æ®µãƒã‚§ãƒªãƒ¼ (ãƒ•ãƒªãƒ¼ã‚ºç¢ºèªç”¨)");
            break;
        case '0':
            debugForcedRole = "Gæ•°å¢—åŠ -å¼·"; // ãƒã‚ºãƒ¬ã®ä»£ã‚ã‚Šãªã©
//             console.log("ã€ãƒ‡ãƒãƒƒã‚°ã€‘æ¬¡ã‚²ãƒ¼ãƒ : Gæ•°å¢—åŠ -å¼·");*/
            
            
            break;
        case 'y':
        case 'Y':
            credits = credits+100;
            updatePanel();
            Swal.fire({
                title: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’100è¿½åŠ ã—ã¾ã—ãŸã€‚',
                text: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’100è¿½åŠ ã—ã¾ã—ãŸã€‚',
                timer: 700,
                timerProgressBar: true,
                showConfirmButton: false, // OKãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                icon:'success'
            });
            break;
    }
});

function reset(){
    total_payout = 0;
    total_bet = 0;
    total_playGame = 0;
    console.log("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
}

    </script>
</body>

</html>

